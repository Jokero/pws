!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).PersistentWebSocket=n()}(this,function(){"use strict";return function(e,n,o,t){if("function"==typeof n&&("object"==typeof o&&(t=o),o=n,n=void 0),Array.isArray(n)||"object"!=typeof n||(t=n,n=void 0),"object"==typeof o&&(t=o,o=void 0),o||"undefined"!=typeof window&&(o=window.WebSocket,"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("online",v)),!o)throw new Error("Please supply a websocket library to use");t||(t={});var r,i=null,c=!1,u=null,a=null,f=null,s=!1,l=Date.now(),p={},d={},y={},m={},E={CONNECTING:"CONNECTING"in o?o.CONNECTING:0,OPEN:"OPEN"in o?o.OPEN:1,CLOSING:"CLOSING"in o?o.CLOSING:2,CLOSED:"CLOSED"in o?o.CLOSED:3,get readyState(){return i.readyState},get protocol(){return i.protocol},get extensions(){return i.extensions},get bufferedAmount(){return i.bufferedAmount},get binaryType(){return i.binaryType},set binaryType(e){f=e,i.binaryType=e},connect:v,url:e,retries:0,pingTimeout:"pingTimeout"in t&&t.pingTimeout,maxTimeout:t.maxTimeout||3e5,maxRetries:t.maxRetries||0,nextReconnectDelay:t.nextReconnectDelay||function(e){return Math.min((1+Math.random())*Math.pow(1.5,e)*1e3,E.maxTimeout)},send:function(){i.send.apply(i,arguments)},close:function(){clearTimeout(u),s=!0,i.close.apply(i,arguments)},onopen:t.onopen,onmessage:t.onmessage,onclose:t.onclose,onerror:t.onerror},w=function(e,n,o){return function(t,c,u){function a(n){u&&u.once&&i["on"===e?"off":"removeEventListener"](t,a),n&&"object"==typeof n&&r&&(n.reconnectDelay=r),c.apply(E,arguments)}t in n?n[t].push(c):n[t]=[c],t in o?o[t].push(a):o[t]=[a],i&&i[e](t,a)}},T=function(e,n,o){return function(t,r){var c=n[t].indexOf(r);-1!==c&&(i&&i[e](t,o[t][c]),n[t].splice(c,1),o[t].splice(c,1))}};return E.addEventListener=w("addEventListener",p,d),E.removeEventListener=T("removeEventListener",p,d),E.on=w("on",y,m),E.off=T("off",y,m),E.once=function(e,n){return E.on(e,n,{once:!0})},e&&v(),E;function v(e){if(s=!1,clearTimeout(u),"string"==typeof e&&(E.url=e),i)return L(4665,"Manual connect initiated");c=!1,(i=new o("function"==typeof E.url?E.url(E):E.url,n,t)).onclose=b,i.onerror=h,i.onopen=g,i.onmessage=O,Object.keys(d).forEach(function(e){d[e].forEach(function(n){return i.addEventListener(e,n)})}),Object.keys(m).forEach(function(e){m[e].forEach(function(n){return i.on(e,n)})}),f&&(i.binaryType=f)}function b(e,n){E.onclose&&E.onclose.apply(E,arguments),clearTimeout(a),s||(r=e.reconnectDelay=Math.ceil(C())),i=null}function h(e){E.onerror&&E.onerror.apply(E,arguments),e||(e=new Error("UnknownError")),r=e.reconnectDelay=Math.ceil(C())}function g(e){E.onopen&&E.onopen.apply(E,arguments),x(),Date.now()-l>E.maxTimeout&&(E.retries=0),l=Date.now()}function O(e){E.onmessage&&E.onmessage.apply(E,arguments),x()}function x(){E.pingTimeout&&(clearTimeout(a),a=setTimeout(N,E.pingTimeout))}function N(){L(4663,"No heartbeat received within "+E.pingTimeout+"ms")}function C(){if(c)return Date.now()-c;if(c=Date.now(),E.retries++,!(E.maxRetries&&E.retries>=E.maxRetries)){var e=E.nextReconnectDelay(E.retries);return u=setTimeout(v,e),e}}function L(e,n){setTimeout(D,0,i);var o=function(e,n){var o;return"undefined"!=typeof window&&window.CloseEvent?o=new window.CloseEvent("HeartbeatTimeout",{wasClean:!0,code:e,reason:n}):((o=new Error("HeartbeatTimeout")).code=e,o.reason=n),o}(e,n);b(o),d.close&&d.close.forEach(function(e){return e(o)}),m.close&&m.close.forEach(function(o){return o(e,n,r)})}function D(e){e.onclose=e.onopen=e.onerror=e.onmessage=null,Object.keys(d).forEach(function(n){d[n].forEach(function(o){return e.removeEventListener(n,o)})}),Object.keys(m).forEach(function(n){m[n].forEach(function(o){return e.off(n,o)})}),e.close()}}});
