!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.PersistentWebSocket=n()}(this,function(){"use strict";return function(e,n,o,t){if("function"==typeof n&&(o=n,n=void 0),Array.isArray(n)||"object"!=typeof n||(t=n,n=void 0),"object"==typeof o&&(t=o,o=void 0),o||"undefined"!=typeof window&&(o=window.WebSocket,"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("online",p)),!o)throw new Error("Please supply a websocket library to use");t||(t={});var r=null,i=!1,u=null,c=null,a=null,s=!1,l={open:[],close:[],error:[],message:[]},f={CONNECTING:"CONNECTING"in o?o.CONNECTING:0,OPEN:"OPEN"in o?o.OPEN:1,CLOSING:"CLOSING"in o?o.CLOSING:2,CLOSED:"CLOSED"in o?o.CLOSED:3,get readyState(){return r.readyState},get protocol(){return r.protocol},get extensions(){return r.extensions},get bufferedAmount(){return r.bufferedAmount},get binaryType(){return r.binaryType},set binaryType(e){a=e,r.binaryType=e},connect:p,url:e,retries:0,pingTimeout:"pingTimeout"in t&&t.pingTimeout,maxTimeout:t.maxTimeout||3e5,maxRetries:t.maxRetries||0,nextReconnectDelay:t.nextReconnectDelay||function(e){return Math.min((1+Math.random())*Math.pow(1.5,e)*1e3,f.maxTimeout)},send:function(){r.send.apply(r,arguments)},close:function(){clearTimeout(u),s=!0,r.close.apply(r,arguments)},onopen:t.onopen,onmessage:t.onmessage,onclose:t.onclose,onerror:t.onerror};return f.addEventListener=f.on=function(e,n){l[e].push(n),r&&(r.on||r.addEventListener).call(r,e,n)},f.removeEventListener=f.off=function(e,n){l[e].splice(l[e].indexOf(n),1),r&&(r.off||r.removeEventListener).call(r,e,n)},f.once=function(e,n){f.addEventListener(e,function o(t){f.removeEventListener(e,o),n(t)})},e&&p(),f;function p(e){s=!1,clearTimeout(u),"string"==typeof e&&(f.url=e),r&&b(r),i=!1,r=new o("function"==typeof f.url?f.url(f):f.url,n,t),Object.keys(l).forEach(function(e){l[e].forEach(function(n){return(r.on||r.addEventListener).call(r,e,n)})}),a&&(r.binaryType=a),r.onclose=d,r.onerror=m,r.onopen=y,r.onmessage=E}function d(e){f.onclose&&f.onerror.apply(f,arguments),r.onclose=null,s||(e.reconnectDelay=Math.ceil(T()))}function m(e){f.onerror&&f.onerror.apply(f,arguments),e||(e=new Error("UnknownError")),e.reconnectDelay=Math.ceil(T())}function y(e){f.onopen&&f.onopen.apply(f,arguments),w(),f.retries=0}function E(e){f.onmessage&&f.onmessage.apply(f,arguments),w()}function w(){f.pingTimeout&&(clearTimeout(c),c=setTimeout(v,f.pingTimeout))}function v(){var e,n="No heartbeat received in due time";"undefined"!=typeof window&&window.CloseEvent?e=new window.CloseEvent("HeartbeatTimeout",{wasClean:!0,code:4663,reason:n}):((e=new Error("HeartbeatTimeout")).code=4663,e.reason=n),d(e),r.close(4663,n)}function T(){if(i)return Date.now()-i;if(r&&b(r),i=Date.now(),f.retries++,!(f.maxRetries&&f.retries>=f.maxRetries)){var e=f.nextReconnectDelay(f.retries);return u=setTimeout(p,e),e}}function b(e){e.onclose=null,e.onopen=null,e.onerror=function(){},e.onmessage=null,Object.keys(l).forEach(function(n){l[n].forEach(function(o){return(e.off||e.removeEventListener).call(e,n,o)})}),e.close()}}});
