!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.PersistentWebSocket=n()}(this,function(){"use strict";return function(e,n,o,t){if("function"==typeof n&&(o=n,n=void 0),Array.isArray(n)||"object"!=typeof n||(t=n,n=void 0),"object"==typeof o&&(t=o,o=void 0),o||"undefined"!=typeof window&&(o=window.WebSocket,"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("online",w)),!o)throw new Error("Please supply a websocket library to use");t||(t={});var r=null,i=!1,u=null,c=null,a=null,f=!1,s={},l={},p={},d={},y={CONNECTING:"CONNECTING"in o?o.CONNECTING:0,OPEN:"OPEN"in o?o.OPEN:1,CLOSING:"CLOSING"in o?o.CLOSING:2,CLOSED:"CLOSED"in o?o.CLOSED:3,get readyState(){return r.readyState},get protocol(){return r.protocol},get extensions(){return r.extensions},get bufferedAmount(){return r.bufferedAmount},get binaryType(){return r.binaryType},set binaryType(e){a=e,r.binaryType=e},connect:w,url:e,retries:0,pingTimeout:"pingTimeout"in t&&t.pingTimeout,maxTimeout:t.maxTimeout||3e5,maxRetries:t.maxRetries||0,nextReconnectDelay:t.nextReconnectDelay||function(e){return Math.min((1+Math.random())*Math.pow(1.5,e)*1e3,y.maxTimeout)},send:function(){r.send.apply(r,arguments)},close:function(){clearTimeout(u),f=!0,r.close.apply(r,arguments)},onopen:t.onopen,onmessage:t.onmessage,onclose:t.onclose,onerror:t.onerror},m=function(e,n,o){return function(t,i,u){function c(n){u&&u.once&&r["on"===e?"off":"removeEventListener"](t,c),i.call(y,n)}t in n?n[t].push(i):n[t]=[i],t in o?o[t].push(c):o[t]=[c],r&&r[e](t,c)}},E=function(e,n,o){return function(t,i){var u=n[t].indexOf(i);r&&r[e](t,o[t][u]),n[t].splice(u,1),o[t].splice(u,1)}};return y.addEventListener=m("addEventListener",s,l),y.removeEventListener=E("removeEventListener",s,l),y.on=m("on",p,d),y.off=E("off",p,d),y.once=function(e,n){return y.on(e,n,{once:!0})},e&&w(),y;function w(e){f=!1,clearTimeout(u),"string"==typeof e&&(y.url=e),r&&x(r),i=!1,r=new o("function"==typeof y.url?y.url(y):y.url,n,t),Object.keys(l).forEach(function(e){l[e].forEach(function(n){return r.addEventListener(e,n)})}),Object.keys(d).forEach(function(e){d[e].forEach(function(n){return r.on(e,n)})}),a&&(r.binaryType=a),r.onclose=v,r.onerror=T,r.onopen=b,r.onmessage=h}function v(e){y.onclose&&y.onclose.apply(y,arguments),r.onclose=null,Object.keys(l).forEach(function(e){l[e].forEach(function(n){return r.removeEventListener(e,n)})}),Object.keys(d).forEach(function(e){d[e].forEach(function(n){return r.off(e,n)})}),f||(e.reconnectDelay=Math.ceil(N()))}function T(e){y.onerror&&y.onerror.apply(y,arguments),e||(e=new Error("UnknownError")),e.reconnectDelay=Math.ceil(N())}function b(e){y.onopen&&y.onopen.apply(y,arguments),g(),y.retries=0}function h(e){y.onmessage&&y.onmessage.apply(y,arguments),g()}function g(){y.pingTimeout&&(clearTimeout(c),c=setTimeout(O,y.pingTimeout))}function O(){var e,n="No heartbeat received in due time";"undefined"!=typeof window&&window.CloseEvent?e=new window.CloseEvent("HeartbeatTimeout",{wasClean:!0,code:4663,reason:n}):((e=new Error("HeartbeatTimeout")).code=4663,e.reason=n),r.close(4663,n)}function N(){if(i)return Date.now()-i;if(r&&x(r),i=Date.now(),y.retries++,!(y.maxRetries&&y.retries>=y.maxRetries)){var e=y.nextReconnectDelay(y.retries);return u=setTimeout(w,e),e}}function x(e){e.onclose=null,e.onopen=null,e.onerror=function(){},e.onmessage=null,e.close()}}});
