!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.PersistentWebSocket=n()}(this,function(){"use strict";return function(e,n,o,t){if("function"==typeof n&&(o=n,n=void 0),Array.isArray(n)||"object"!=typeof n||(t=n,n=void 0),"object"==typeof o&&(t=o,o=void 0),o||"undefined"!=typeof window&&(o=window.WebSocket,"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("online",p)),!o)throw new Error("Please supply a websocket library to use");t||(t={});var r=null,i=!1,c=null,a=null,u=null,s=!1,f={open:[],close:[],error:[],message:[]},l={CONNECTING:"CONNECTING"in o?o.CONNECTING:0,OPEN:"OPEN"in o?o.OPEN:1,CLOSING:"CLOSING"in o?o.CLOSING:2,CLOSED:"CLOSED"in o?o.CLOSED:3,get readyState(){return r.readyState},get protocol(){return r.protocol},get extensions(){return r.extensions},get bufferedAmount(){return r.bufferedAmount},get binaryType(){return r.binaryType},set binaryType(e){u=e,r.binaryType=e},connect:p,url:e,retries:0,pingTimeout:"pingTimeout"in t&&t.pingTimeout,maxTimeout:t.maxTimeout||3e5,maxRetries:t.maxRetries||0,nextReconnectDelay:t.nextReconnectDelay||function(e){return Math.min((1+Math.random())*Math.pow(1.5,e)*1e3,l.maxTimeout)},send:function(){r.send.apply(r,arguments)},close:function(){clearTimeout(c),s=!0,r.close.apply(r,arguments)},onopen:d,onclose:d,onerror:d,onmessage:d};return l.addEventListener=l.on=function(e,n){f[e].push(n),r&&(r.addEventListener||r.on).call(r,e,n)},l.removeEventListener=l.off=function(e,n){f[e].splice(f[e].indexOf(n),1),r&&(r.removeEventListener||r.off).call(r,e,n)},l.once=function(e,n){l.addEventListener(e,function o(t){l.removeEventListener(e,o),n(t)})},e&&p(),l;function d(){}function p(e){s=!1,clearTimeout(c),"string"==typeof e&&(l.url=e),r&&g(r),i=!1,r=new o(l.url,n,t),Object.keys(f).forEach(function(e){f[e].forEach(function(n){return(r.addEventListener||r.on).call(r,e,n)})}),u&&(r.binaryType=u),r.onclose=y,r.onerror=m,r.onopen=E,r.onmessage=w}function y(e){l.onclose.apply(l,arguments),r.onclose=d,s||(e.reconnectDelay=Math.ceil(b()))}function m(e){l.onerror.apply(l,arguments),e||(e=new Error("UnknownError")),e.reconnectDelay=Math.ceil(b())}function E(e){l.onopen.apply(l,arguments),v(),l.retries=0}function w(e){l.onmessage.apply(l,arguments),v()}function v(){l.pingTimeout&&(clearTimeout(a),a=setTimeout(T,l.pingTimeout))}function T(){var e="No heartbeat received in due time",n="undefined"!=typeof window&&window.CloseEvent?new window.CloseEvent("HeartbeatTimeout",{wasClean:!0,code:4663,reason:e}):new Error("HeartbeatTimeout");n.code=4663,n.reason=e,y(n),r.close(n.code,n.reason)}function b(){if(i)return Date.now()-i;if(r&&g(r),i=Date.now(),l.retries++,!(l.maxRetries&&l.retries>=l.maxRetries)){var e=l.nextReconnectDelay(l.retries);return c=setTimeout(p,e),e}}function g(e){e.onclose=d,e.onopen=d,e.onerror=d,e.onmessage=d,Object.keys(f).forEach(function(n){f[n].forEach(function(o){return(e.removeEventListener||e.off).call(e,n,o)})}),e.close()}}});
